#+TITLE: Cloud Functions로 실시간 이미지 리사이징 하기
#+SUBTITLE: Cloud Functions을 이용해서 On-The-Fly 이미지 리사이징 및 포맷 변경을 해봅시다.
#+LAYOUT: post
#+AUTHOR: yeongcheon
#+DATE: 2021-01-06 23:00:00 +0900
#+TAGS[]: gcp cloudfunctions on-the-fly
#+DRAFT: true

[[https://medium.com/daangn/lambda-edge%EB%A1%9C-%EA%B5%AC%ED%98%84%ED%95%98%EB%8A%94-on-the-fly-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95-f4e5052d49f3][당근마켓]], [[http://engineering.vcnc.co.kr/2016/05/ondemand-image-resizing/][비트윈]] 등에서 작성한 글을 참고하여 GCP 기반으로 비슷한 기능을 하는 코드를 작성하여 봅시다. 동작 원리는 앞서 말한 글에 자세히 나와있으니 서론은 생략하고 바로 시작합니다.

이 문서에서는 GCP의 아래 제품들을 사용합니다.

- [[https://cloud.google.com/functions/docs?hl=ko][Cloud Functions]]
- [[https://cloud.google.com/storage?hl=ko][Cloud Stroage]]
- [[https://cloud.google.com/cdn/docs/using-cdn?hl=ko][Cloud CDN]]


* Cloud Functions
Cloud Function을 호출하는 방법은 여러가지가 있습니다만 이 문서에서는 http 요청을 통해 호출하는 방법을 사용합니다. Cloud Functions에 배포할 코드는 [[https://github.com/YeongCheon/imagick-cf][여기]]에 있습니다. 프로젝트를 받으신 후 프로젝트 루트 폴더에서 아래의 명령어를 실행해서 코드를 배포합니다. 이 명령어를 통해 배포하면 인증되지 않은 사용자도 http 요청을 통해서 함수를 호출할 수 있습니다.

#+BEGIN_SRC bash
gcloud functions deploy OptimizeImage --runtime go113 --trigger-http --region asia-northeast3 --allow-unauthenticated
#+END_SRC
